import{_ as Oe,r,a as le,m as Pe,c as A,d as e,w as t,f as u,s as c,t as Me,o as f,q as P,h as $,e as s,v as p,x as v,F as We,a5 as Ye,a7 as be,b as C,B as ye,ac as Ge,ad as He,N as _e,a3 as we,W as ae,X as te,U as Je,L as ge,E as R}from"./index-Dl24hcOp.js";const Xe={class:"app-container"},Ke={class:"card-header"},Qe={class:"pagination-container"},Ze={class:"node-config"},el={class:"node-header"},ll={key:0,style:{color:"#909399","margin-top":"5px"}},al={__name:"approval",setup(tl){const M=[{label:"资产发行",value:"ASSET_ISSUE"},{label:"大额交易",value:"TRADE_LARGE"},{label:"企业认证",value:"COMPANY_VERIFY"},{label:"项目立项",value:"PROJECT_CREATE"},{label:"减排核算",value:"CARBON_CALCULATE"}],F=o=>{const l=M.find(d=>d.value===o);return l?l.label:o},W=o=>({0:"待审批",1:"审批中",2:"已通过",3:"已驳回",4:"已撤回"})[o]||"未知",Y=o=>({0:"warning",1:"primary",2:"success",3:"danger",4:"info"})[o]||"info",G=r(!1),oe=r([]),U=r(!1),H=r(""),J=r(null),i=le({id:null,flowName:"",flowCode:"",businessType:"",description:"",status:1}),Ve={flowName:[{required:!0,message:"请输入流程名称",trigger:"blur"}],flowCode:[{required:!0,message:"请输入流程编码",trigger:"blur"}],businessType:[{required:!0,message:"请选择业务类型",trigger:"change"}]},E=r(!1),L=r(null),k=r([]),se=r("pending"),w=r(!1),ne=r([]),de=r([]),ie=r([]),ue=r(0),b=le({businessType:"",status:null,page:1,size:10}),j=r(!1),y=r({}),X=r([]),z=r(!1),K=r(""),T=r(""),I=r(null),N=le({comment:""}),Q=async()=>{G.value=!0;try{const o=await c({url:"/api/system/approval/flow/list",method:"get",params:{page:1,size:100}});o.code===200&&(oe.value=o.data.records||[])}catch(o){console.error("加载流程失败:",o)}finally{G.value=!1}},Ce=()=>{re(),H.value="新增流程",U.value=!0},ke=o=>{re(),Object.assign(i,o),H.value="编辑流程",U.value=!0},Te=async o=>{try{await ge.confirm(`确定要删除流程"${o.flowName}"吗？`,"提示",{type:"warning"}),(await c({url:`/api/system/approval/flow/${o.id}`,method:"delete"})).code===200&&(R.success("删除成功"),Q())}catch(l){l!=="cancel"&&console.error("删除失败:",l)}},Ne=async()=>{try{await J.value?.validate();const o=!!i.id;(o?await c({url:"/api/system/approval/flow",method:"put",data:i}):await c({url:"/api/system/approval/flow",method:"post",data:i})).code===200&&(R.success(o?"更新成功":"创建成功"),U.value=!1,Q())}catch(o){console.error("提交失败:",o)}},re=()=>{i.id=null,i.flowName="",i.flowCode="",i.businessType="",i.description="",i.status=1,J.value?.resetFields()},he=async o=>{L.value=o;try{const l=await c({url:`/api/system/approval/flow/${o.id}/nodes`,method:"get"});l.code===200&&(k.value=l.data||[])}catch{k.value=[]}E.value=!0},Ue=()=>{k.value.push({nodeName:"",nodeOrder:k.value.length+1,approverType:1,approverId:null,approverName:"",allowTransfer:0,allowReject:1,status:1})},ze=o=>{k.value.splice(o,1),k.value.forEach((l,d)=>{l.nodeOrder=d+1})},xe=async()=>{if(L.value)try{(await c({url:`/api/system/approval/flow/${L.value.id}/nodes`,method:"post",data:k.value})).code===200&&(R.success("保存成功"),E.value=!1)}catch(o){console.error("保存节点失败:",o)}},pe=async()=>{w.value=!0;try{const o=await c({url:"/api/system/approval/pending",method:"get"});o.code===200&&(ne.value=o.data||[])}catch(o){console.error("加载待审批失败:",o)}finally{w.value=!1}},me=async()=>{w.value=!0;try{const o=await c({url:"/api/system/approval/my-applied",method:"get",params:{page:1,size:50}});o.code===200&&(de.value=o.data.records||[])}catch(o){console.error("加载我发起的审批失败:",o)}finally{w.value=!1}},S=async()=>{w.value=!0;try{const o=await c({url:"/api/system/approval/record/list",method:"get",params:b});o.code===200&&(ie.value=o.data.records||[],ue.value=o.data.total||0)}catch(o){console.error("加载全部记录失败:",o)}finally{w.value=!1}},ce=async o=>{y.value=o;try{const l=await c({url:`/api/system/approval/record/${o.id}`,method:"get"});l.code===200&&(y.value=l.data.record,X.value=l.data.histories||[])}catch{X.value=[]}j.value=!0},$e=o=>{I.value=o.id,T.value="approve",K.value="审批通过",N.comment="",z.value=!0},Re=o=>{I.value=o.id,T.value="reject",K.value="审批驳回",N.comment="",z.value=!0},Fe=async()=>{if(T.value==="reject"&&!N.comment){R.warning("驳回原因不能为空");return}try{const o=T.value==="approve"?`/api/system/approval/approve/${I.value}`:`/api/system/approval/reject/${I.value}`;(await c({url:o,method:"post",data:{comment:N.comment}})).code===200&&(R.success(T.value==="approve"?"审批通过":"已驳回"),z.value=!1,pe())}catch(o){console.error("审批失败:",o)}},Ee=async o=>{try{await ge.confirm("确定要撤回该审批申请吗？","提示",{type:"warning"}),(await c({url:`/api/system/approval/withdraw/${o.id}`,method:"post"})).code===200&&(R.success("撤回成功"),me())}catch(l){l!=="cancel"&&console.error("撤回失败:",l)}};return Pe(()=>{Q(),pe(),me(),S()}),(o,l)=>{const d=u("el-button"),n=u("el-table-column"),_=u("el-tag"),D=u("el-table"),fe=u("el-card"),Z=u("el-tab-pane"),g=u("el-option"),B=u("el-select"),V=u("el-form-item"),ee=u("el-form"),De=u("el-pagination"),Ae=u("el-tabs"),x=u("el-input"),ve=u("el-radio"),Le=u("el-radio-group"),q=u("el-dialog"),je=u("el-switch"),h=u("el-descriptions-item"),Ie=u("el-descriptions"),Se=u("el-divider"),Be=u("el-timeline-item"),qe=u("el-timeline"),O=Me("loading");return f(),A("div",Xe,[e(fe,{shadow:"never",class:"mb20"},{header:t(()=>[C("div",Ke,[l[20]||(l[20]=C("span",null,"审批流程管理",-1)),e(d,{type:"primary",icon:v(ye),onClick:Ce},{default:t(()=>[...l[19]||(l[19]=[s("新增流程",-1)])]),_:1},8,["icon"])])]),default:t(()=>[P((f(),$(D,{data:oe.value,style:{width:"100%"}},{default:t(()=>[e(n,{prop:"id",label:"ID",width:"60"}),e(n,{prop:"flowName",label:"流程名称",width:"150"}),e(n,{prop:"flowCode",label:"流程编码",width:"160"},{default:t(({row:a})=>[e(_,{type:"info",size:"small"},{default:t(()=>[s(p(a.flowCode),1)]),_:2},1024)]),_:1}),e(n,{prop:"businessType",label:"业务类型",width:"130"},{default:t(({row:a})=>[e(_,{size:"small"},{default:t(()=>[s(p(F(a.businessType)),1)]),_:2},1024)]),_:1}),e(n,{prop:"description",label:"描述","min-width":"200","show-overflow-tooltip":""}),e(n,{prop:"status",label:"状态",width:"80"},{default:t(({row:a})=>[e(_,{type:a.status===1?"success":"danger",size:"small"},{default:t(()=>[s(p(a.status===1?"启用":"停用"),1)]),_:2},1032,["type"])]),_:1}),e(n,{label:"操作",width:"200",fixed:"right"},{default:t(({row:a})=>[e(d,{type:"primary",link:"",icon:v(We),onClick:m=>he(a)},{default:t(()=>[...l[21]||(l[21]=[s("配置节点",-1)])]),_:1},8,["icon","onClick"]),e(d,{type:"primary",link:"",icon:v(Ye),onClick:m=>ke(a)},{default:t(()=>[...l[22]||(l[22]=[s("编辑",-1)])]),_:1},8,["icon","onClick"]),e(d,{type:"danger",link:"",icon:v(be),onClick:m=>Te(a)},{default:t(()=>[...l[23]||(l[23]=[s("删除",-1)])]),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["data"])),[[O,G.value]])]),_:1}),e(fe,{shadow:"never"},{header:t(()=>[...l[24]||(l[24]=[C("span",null,"审批记录",-1)])]),default:t(()=>[e(Ae,{modelValue:se.value,"onUpdate:modelValue":l[4]||(l[4]=a=>se.value=a)},{default:t(()=>[e(Z,{label:"待我审批",name:"pending"},{default:t(()=>[P((f(),$(D,{data:ne.value,style:{width:"100%"}},{default:t(()=>[e(n,{prop:"id",label:"ID",width:"60"}),e(n,{prop:"businessTitle",label:"业务标题","min-width":"200","show-overflow-tooltip":""}),e(n,{prop:"businessType",label:"业务类型",width:"120"},{default:t(({row:a})=>[e(_,{size:"small"},{default:t(()=>[s(p(F(a.businessType)),1)]),_:2},1024)]),_:1}),e(n,{prop:"applicantName",label:"申请人",width:"100"}),e(n,{prop:"currentNodeName",label:"当前节点",width:"120"}),e(n,{prop:"applyTime",label:"申请时间",width:"170"}),e(n,{label:"操作",width:"150",fixed:"right"},{default:t(({row:a})=>[e(d,{type:"success",link:"",icon:v(Ge),onClick:m=>$e(a)},{default:t(()=>[...l[25]||(l[25]=[s("通过",-1)])]),_:1},8,["icon","onClick"]),e(d,{type:"danger",link:"",icon:v(He),onClick:m=>Re(a)},{default:t(()=>[...l[26]||(l[26]=[s("驳回",-1)])]),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["data"])),[[O,w.value]])]),_:1}),e(Z,{label:"我发起的",name:"applied"},{default:t(()=>[P((f(),$(D,{data:de.value,style:{width:"100%"}},{default:t(()=>[e(n,{prop:"id",label:"ID",width:"60"}),e(n,{prop:"businessTitle",label:"业务标题","min-width":"200","show-overflow-tooltip":""}),e(n,{prop:"businessType",label:"业务类型",width:"120"},{default:t(({row:a})=>[e(_,{size:"small"},{default:t(()=>[s(p(F(a.businessType)),1)]),_:2},1024)]),_:1}),e(n,{prop:"currentNodeName",label:"当前节点",width:"120"}),e(n,{prop:"status",label:"状态",width:"90"},{default:t(({row:a})=>[e(_,{type:Y(a.status),size:"small"},{default:t(()=>[s(p(W(a.status)),1)]),_:2},1032,["type"])]),_:1}),e(n,{prop:"applyTime",label:"申请时间",width:"170"}),e(n,{label:"操作",width:"120",fixed:"right"},{default:t(({row:a})=>[e(d,{type:"primary",link:"",icon:v(we),onClick:m=>ce(a)},{default:t(()=>[...l[27]||(l[27]=[s("详情",-1)])]),_:1},8,["icon","onClick"]),a.status<2?(f(),$(d,{key:0,type:"warning",link:"",onClick:m=>Ee(a)},{default:t(()=>[...l[28]||(l[28]=[s("撤回",-1)])]),_:1},8,["onClick"])):_e("",!0)]),_:1})]),_:1},8,["data"])),[[O,w.value]])]),_:1}),e(Z,{label:"全部记录",name:"all"},{default:t(()=>[e(ee,{inline:!0,model:b,class:"search-form"},{default:t(()=>[e(V,{label:"业务类型"},{default:t(()=>[e(B,{modelValue:b.businessType,"onUpdate:modelValue":l[0]||(l[0]=a=>b.businessType=a),placeholder:"请选择",clearable:"",style:{width:"150px"}},{default:t(()=>[(f(),A(ae,null,te(M,a=>e(g,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),e(V,{label:"状态"},{default:t(()=>[e(B,{modelValue:b.status,"onUpdate:modelValue":l[1]||(l[1]=a=>b.status=a),placeholder:"请选择",clearable:"",style:{width:"120px"}},{default:t(()=>[e(g,{label:"待审批",value:0}),e(g,{label:"审批中",value:1}),e(g,{label:"已通过",value:2}),e(g,{label:"已驳回",value:3}),e(g,{label:"已撤回",value:4})]),_:1},8,["modelValue"])]),_:1}),e(V,null,{default:t(()=>[e(d,{type:"primary",icon:v(Je),onClick:S},{default:t(()=>[...l[29]||(l[29]=[s("搜索",-1)])]),_:1},8,["icon"])]),_:1})]),_:1},8,["model"]),P((f(),$(D,{data:ie.value,style:{width:"100%"}},{default:t(()=>[e(n,{prop:"id",label:"ID",width:"60"}),e(n,{prop:"businessTitle",label:"业务标题","min-width":"180","show-overflow-tooltip":""}),e(n,{prop:"businessType",label:"业务类型",width:"120"},{default:t(({row:a})=>[e(_,{size:"small"},{default:t(()=>[s(p(F(a.businessType)),1)]),_:2},1024)]),_:1}),e(n,{prop:"applicantName",label:"申请人",width:"100"}),e(n,{prop:"currentNodeName",label:"当前节点",width:"120"}),e(n,{prop:"status",label:"状态",width:"90"},{default:t(({row:a})=>[e(_,{type:Y(a.status),size:"small"},{default:t(()=>[s(p(W(a.status)),1)]),_:2},1032,["type"])]),_:1}),e(n,{prop:"applyTime",label:"申请时间",width:"170"}),e(n,{label:"操作",width:"80",fixed:"right"},{default:t(({row:a})=>[e(d,{type:"primary",link:"",icon:v(we),onClick:m=>ce(a)},{default:t(()=>[...l[30]||(l[30]=[s("详情",-1)])]),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["data"])),[[O,w.value]]),C("div",Qe,[e(De,{"current-page":b.page,"onUpdate:currentPage":l[2]||(l[2]=a=>b.page=a),"page-size":b.size,"onUpdate:pageSize":l[3]||(l[3]=a=>b.size=a),"page-sizes":[10,20,50],total:ue.value,layout:"total, sizes, prev, pager, next",onSizeChange:S,onCurrentChange:S},null,8,["current-page","page-size","total"])])]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(q,{modelValue:U.value,"onUpdate:modelValue":l[11]||(l[11]=a=>U.value=a),title:H.value,width:"500px"},{footer:t(()=>[e(d,{onClick:l[10]||(l[10]=a=>U.value=!1)},{default:t(()=>[...l[33]||(l[33]=[s("取消",-1)])]),_:1}),e(d,{type:"primary",onClick:Ne},{default:t(()=>[...l[34]||(l[34]=[s("确定",-1)])]),_:1})]),default:t(()=>[e(ee,{ref_key:"flowFormRef",ref:J,model:i,rules:Ve,"label-width":"100px"},{default:t(()=>[e(V,{label:"流程名称",prop:"flowName"},{default:t(()=>[e(x,{modelValue:i.flowName,"onUpdate:modelValue":l[5]||(l[5]=a=>i.flowName=a),placeholder:"请输入流程名称"},null,8,["modelValue"])]),_:1}),e(V,{label:"流程编码",prop:"flowCode"},{default:t(()=>[e(x,{modelValue:i.flowCode,"onUpdate:modelValue":l[6]||(l[6]=a=>i.flowCode=a),placeholder:"请输入流程编码",disabled:!!i.id},null,8,["modelValue","disabled"])]),_:1}),e(V,{label:"业务类型",prop:"businessType"},{default:t(()=>[e(B,{modelValue:i.businessType,"onUpdate:modelValue":l[7]||(l[7]=a=>i.businessType=a),placeholder:"请选择业务类型",style:{width:"100%"}},{default:t(()=>[(f(),A(ae,null,te(M,a=>e(g,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),e(V,{label:"描述",prop:"description"},{default:t(()=>[e(x,{modelValue:i.description,"onUpdate:modelValue":l[8]||(l[8]=a=>i.description=a),type:"textarea",rows:3,placeholder:"请输入流程描述"},null,8,["modelValue"])]),_:1}),e(V,{label:"状态",prop:"status"},{default:t(()=>[e(Le,{modelValue:i.status,"onUpdate:modelValue":l[9]||(l[9]=a=>i.status=a)},{default:t(()=>[e(ve,{value:1},{default:t(()=>[...l[31]||(l[31]=[s("启用",-1)])]),_:1}),e(ve,{value:0},{default:t(()=>[...l[32]||(l[32]=[s("停用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(q,{modelValue:E.value,"onUpdate:modelValue":l[13]||(l[13]=a=>E.value=a),title:"配置审批节点",width:"700px"},{footer:t(()=>[e(d,{onClick:l[12]||(l[12]=a=>E.value=!1)},{default:t(()=>[...l[37]||(l[37]=[s("取消",-1)])]),_:1}),e(d,{type:"primary",onClick:xe},{default:t(()=>[...l[38]||(l[38]=[s("保存节点",-1)])]),_:1})]),default:t(()=>[C("div",Ze,[C("div",el,[C("span",null,"流程："+p(L.value?.flowName),1),e(d,{type:"primary",size:"small",icon:v(ye),onClick:Ue},{default:t(()=>[...l[35]||(l[35]=[s("添加节点",-1)])]),_:1},8,["icon"])]),e(D,{data:k.value,style:{width:"100%"}},{default:t(()=>[e(n,{prop:"nodeOrder",label:"序号",width:"60"}),e(n,{prop:"nodeName",label:"节点名称",width:"150"},{default:t(({row:a})=>[e(x,{modelValue:a.nodeName,"onUpdate:modelValue":m=>a.nodeName=m,size:"small",placeholder:"节点名称"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(n,{prop:"approverType",label:"审批类型",width:"130"},{default:t(({row:a})=>[e(B,{modelValue:a.approverType,"onUpdate:modelValue":m=>a.approverType=m,size:"small"},{default:t(()=>[e(g,{label:"角色审批",value:1}),e(g,{label:"指定用户",value:2})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),e(n,{prop:"approverName",label:"审批人/角色",width:"150"},{default:t(({row:a})=>[e(x,{modelValue:a.approverName,"onUpdate:modelValue":m=>a.approverName=m,size:"small",placeholder:"审批人名称"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(n,{label:"允许驳回",width:"90"},{default:t(({row:a})=>[e(je,{modelValue:a.allowReject,"onUpdate:modelValue":m=>a.allowReject=m,"active-value":1,"inactive-value":0},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(n,{label:"操作",width:"100"},{default:t(({row:a,$index:m})=>[e(d,{type:"danger",link:"",icon:v(be),onClick:ol=>ze(m)},{default:t(()=>[...l[36]||(l[36]=[s("删除",-1)])]),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["data"])])]),_:1},8,["modelValue"]),e(q,{modelValue:j.value,"onUpdate:modelValue":l[15]||(l[15]=a=>j.value=a),title:"审批详情",width:"650px"},{footer:t(()=>[e(d,{onClick:l[14]||(l[14]=a=>j.value=!1)},{default:t(()=>[...l[40]||(l[40]=[s("关闭",-1)])]),_:1})]),default:t(()=>[e(Ie,{column:2,border:""},{default:t(()=>[e(h,{label:"业务标题",span:2},{default:t(()=>[s(p(y.value.businessTitle),1)]),_:1}),e(h,{label:"业务类型"},{default:t(()=>[s(p(F(y.value.businessType)),1)]),_:1}),e(h,{label:"申请人"},{default:t(()=>[s(p(y.value.applicantName),1)]),_:1}),e(h,{label:"当前节点"},{default:t(()=>[s(p(y.value.currentNodeName),1)]),_:1}),e(h,{label:"状态"},{default:t(()=>[e(_,{type:Y(y.value.status),size:"small"},{default:t(()=>[s(p(W(y.value.status)),1)]),_:1},8,["type"])]),_:1}),e(h,{label:"申请时间"},{default:t(()=>[s(p(y.value.applyTime),1)]),_:1}),e(h,{label:"完成时间"},{default:t(()=>[s(p(y.value.completeTime||"-"),1)]),_:1})]),_:1}),e(Se,{"content-position":"left"},{default:t(()=>[...l[39]||(l[39]=[s("审批历史",-1)])]),_:1}),e(qe,null,{default:t(()=>[(f(!0),A(ae,null,te(X.value,(a,m)=>(f(),$(Be,{key:m,type:a.action===1?"success":a.action===2?"danger":"primary",timestamp:a.approveTime},{default:t(()=>[C("div",null,[C("strong",null,p(a.nodeName),1),s(" - "+p(a.approverName)+" ",1),e(_,{type:a.action===1?"success":"danger",size:"small",style:{"margin-left":"10px"}},{default:t(()=>[s(p(a.action===1?"通过":a.action===2?"驳回":"转交"),1)]),_:2},1032,["type"])]),a.comment?(f(),A("p",ll,p(a.comment),1)):_e("",!0)]),_:2},1032,["type","timestamp"]))),128))]),_:1})]),_:1},8,["modelValue"]),e(q,{modelValue:z.value,"onUpdate:modelValue":l[18]||(l[18]=a=>z.value=a),title:K.value,width:"450px"},{footer:t(()=>[e(d,{onClick:l[17]||(l[17]=a=>z.value=!1)},{default:t(()=>[...l[41]||(l[41]=[s("取消",-1)])]),_:1}),e(d,{type:T.value==="approve"?"success":"danger",onClick:Fe},{default:t(()=>[s(p(T.value==="approve"?"确认通过":"确认驳回"),1)]),_:1},8,["type"])]),default:t(()=>[e(ee,{model:N,"label-width":"80px"},{default:t(()=>[e(V,{label:"审批意见",required:T.value==="reject"},{default:t(()=>[e(x,{modelValue:N.comment,"onUpdate:modelValue":l[16]||(l[16]=a=>N.comment=a),type:"textarea",rows:4,placeholder:"请输入审批意见"},null,8,["modelValue"])]),_:1},8,["required"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},nl=Oe(al,[["__scopeId","data-v-39eaed26"]]);export{nl as default};

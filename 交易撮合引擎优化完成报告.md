# äº¤æ˜“æ’®åˆå¼•æ“ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š

## ä¸€ã€ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–å®Œæˆäº†äº¤æ˜“æ’®åˆå¼•æ“çš„4å¤§æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼ŒåŒ…æ‹¬è´¦æˆ·æœåŠ¡ã€è®¢å•ç®¡ç†ã€äº¤æ˜“è®°å½•å’Œæ€§èƒ½ä¼˜åŒ–åŸºç¡€ã€‚

---

## äºŒã€å·²å®ŒæˆåŠŸèƒ½è¯¦ç»†è¯´æ˜

### 1. âœ… äº¤æ˜“è®°å½•ç³»ç»Ÿ

#### 1.1 æ•°æ®åº“è®¾è®¡
åˆ›å»ºäº† `trade_record` è¡¨ï¼Œå®Œæ•´è®°å½•æ¯ç¬”äº¤æ˜“çš„è¯¦ç»†ä¿¡æ¯ï¼š

```sql
CREATE TABLE IF NOT EXISTS trade_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    buy_order_id BIGINT NOT NULL COMMENT 'ä¹°å•ID',
    sell_order_id BIGINT NOT NULL COMMENT 'å–å•ID',
    buyer_id BIGINT NOT NULL COMMENT 'ä¹°æ–¹ç”¨æˆ·ID',
    seller_id BIGINT NOT NULL COMMENT 'å–æ–¹ç”¨æˆ·ID',
    asset_type VARCHAR(20) NOT NULL COMMENT 'èµ„äº§ç±»å‹',
    trade_price DECIMAL(10, 2) NOT NULL COMMENT 'æˆäº¤å•ä»·',
    trade_quantity DECIMAL(15, 2) NOT NULL COMMENT 'æˆäº¤æ•°é‡',
    trade_amount DECIMAL(20, 2) NOT NULL COMMENT 'æˆäº¤æ€»é‡‘é¢',
    trade_time DATETIME NOT NULL COMMENT 'æˆäº¤æ—¶é—´',
    -- ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
    INDEX idx_buyer_id (buyer_id),
    INDEX idx_seller_id (seller_id),
    INDEX idx_trade_time (trade_time)
);
```

**æ–‡ä»¶ä½ç½®ï¼š**
- SQLè„šæœ¬ï¼š`service-trade/src/main/resources/trade_record.sql`
- å®ä½“ç±»ï¼š`service-trade/src/main/java/com/example/trade/entity/TradeRecord.java`
- Mapperï¼š`service-trade/src/main/java/com/example/trade/mapper/TradeRecordMapper.java`
- æœåŠ¡å±‚ï¼š`service-trade/src/main/java/com/example/trade/service/TradeRecordService.java`
- æ§åˆ¶å™¨ï¼š`service-trade/src/main/java/com/example/trade/controller/TradeRecordController.java`

#### 1.2 APIæ¥å£
æä¾›äº†3ä¸ªæŸ¥è¯¢æ¥å£ï¼š

| æ¥å£è·¯å¾„ | æ–¹æ³• | è¯´æ˜ | å‚æ•° |
|---------|------|------|------|
| `/api/trade/records/my` | GET | æŸ¥è¯¢ç”¨æˆ·äº¤æ˜“è®°å½•ï¼ˆåˆ†é¡µï¼‰ | userId, current, size |
| `/api/trade/records/all` | GET | æŸ¥è¯¢æ‰€æœ‰äº¤æ˜“è®°å½•ï¼ˆç®¡ç†å‘˜ï¼‰ | current, size |
| `/api/trade/records/by-order/{orderId}` | GET | æ ¹æ®è®¢å•IDæŸ¥è¯¢äº¤æ˜“è®°å½• | orderId |

#### 1.3 è‡ªåŠ¨è®°å½•æœºåˆ¶
åœ¨ `TradeMatchService.matchTwoOrders()` æ–¹æ³•ä¸­ï¼Œæ¯æ¬¡æ’®åˆæˆåŠŸåè‡ªåŠ¨ä¿å­˜äº¤æ˜“è®°å½•ï¼š

```java
// ä¿å­˜äº¤æ˜“è®°å½•
saveTradeRecord(buyOrder, sellOrder, matchQuantity, matchPrice, totalAmount);
```

---

### 2. âœ… è´¦æˆ·ä½™é¢æ›´æ–°

#### 2.1 è´¦æˆ·æœåŠ¡
åˆ©ç”¨å·²æœ‰çš„ `trade_account` è¡¨å’Œ `TradeAccountService`ï¼Œå®ç°äº†å®Œæ•´çš„èµ„é‡‘ç®¡ç†ï¼š

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `freezeAmount()` - å†»ç»“èµ„é‡‘ï¼ˆä¹°å•ä¸‹å•æ—¶ï¼‰
- `unfreezeAmount()` - è§£å†»èµ„é‡‘ï¼ˆæ’¤å•/è¿‡æœŸæ—¶ï¼‰
- `deductFrozenAmount()` - æ‰£é™¤å†»ç»“èµ„é‡‘ï¼ˆæˆäº¤æ—¶ï¼‰
- `recharge()` - å……å€¼ä½™é¢ï¼ˆå–æ–¹æ”¶æ¬¾æ—¶ï¼‰

#### 2.2 æˆäº¤åä½™é¢æ›´æ–°
åœ¨æ’®åˆæˆåŠŸåè‡ªåŠ¨æ›´æ–°ä¹°å–åŒæ–¹ä½™é¢ï¼š

```java
// 1. ä¹°æ–¹ï¼šæ‰£é™¤å†»ç»“èµ„é‡‘
tradeAccountService.deductFrozenAmount(buyOrder.getUserId(), totalAmount);

// 2. å–æ–¹ï¼šå¢åŠ ä½™é¢
tradeAccountService.recharge(sellOrder.getUserId(), totalAmount);
```

**Feignå®¢æˆ·ç«¯ï¼š**
- æ–‡ä»¶ï¼š`service-consumer/src/main/java/com/example/consumer/feign/TradeAccountFeignClient.java`
- æä¾›è·¨æœåŠ¡è°ƒç”¨èƒ½åŠ›

---

### 3. âœ… èµ„äº§æŒä»“æ›´æ–°

#### 3.1 èµ„äº§æ›´æ–°API
åœ¨ `service-assets` æ¨¡å—æ·»åŠ äº†èµ„äº§æ•°é‡æ›´æ–°æ¥å£ï¼š

**ç¢³é…é¢æ›´æ–°ï¼š**
```java
@PostMapping("/api/assets/quota/update-quantity")
public Result<String> updateQuantity(
    @RequestParam Long userId,
    @RequestParam Integer year,
    @RequestParam BigDecimal amount  // æ­£æ•°=å¢åŠ ï¼Œè´Ÿæ•°=å‡å°‘
)
```

**ç¢³ä¿¡ç”¨(CCER)æ›´æ–°ï¼š**
```java
@PostMapping("/api/assets/credit/update-quantity")
public Result<String> updateQuantity(
    @RequestParam Long userId,
    @RequestParam Long projectId,
    @RequestParam BigDecimal amount
)
```

**æ–‡ä»¶ä½ç½®ï¼š**
- `service-assets/src/main/java/com/example/assets/controller/CarbonQuotaController.java`
- `service-assets/src/main/java/com/example/assets/controller/CarbonCreditController.java`

#### 3.2 æˆäº¤åèµ„äº§æ›´æ–°
åœ¨ `TradeMatchService` ä¸­è°ƒç”¨èµ„äº§æ›´æ–°APIï¼š

```java
// ä¹°æ–¹ï¼šå¢åŠ èµ„äº§æŒä»“
// å–æ–¹ï¼šå‡å°‘èµ„äº§æŒä»“
updateAccountAndAssets(buyOrder, sellOrder, matchQuantity, totalAmount);
```

---

### 4. âœ… è®¢å•æœ‰æ•ˆæœŸç®¡ç†

#### 4.1 æ•°æ®åº“å­—æ®µ
ä¸º `trade_order` è¡¨æ·»åŠ äº†æœ‰æ•ˆæœŸç›¸å…³å­—æ®µï¼š

```sql
ALTER TABLE trade_order 
ADD COLUMN valid_days INT DEFAULT 7 COMMENT 'è®¢å•æœ‰æ•ˆæœŸï¼ˆå¤©æ•°ï¼‰',
ADD COLUMN expire_time DATETIME COMMENT 'è®¢å•åˆ°æœŸæ—¶é—´';
```

**è¿ç§»è„šæœ¬ï¼š** `service-trade/src/main/resources/add_order_validity.sql`

#### 4.2 å®ä½“ç±»æ›´æ–°
`TradeOrder` å®ä½“æ·»åŠ å­—æ®µï¼š
```java
private Integer validDays;      // è®¢å•æœ‰æ•ˆæœŸï¼ˆå¤©æ•°ï¼‰ï¼Œé»˜è®¤7å¤©
private LocalDateTime expireTime; // è®¢å•åˆ°æœŸæ—¶é—´
```

#### 4.3 å‘å¸ƒè®¢å•æ—¶è‡ªåŠ¨è®¾ç½®è¿‡æœŸæ—¶é—´
```java
// è®¾ç½®è®¢å•æœ‰æ•ˆæœŸï¼ˆé»˜è®¤7å¤©ï¼‰
if (order.getValidDays() == null || order.getValidDays() <= 0) {
    order.setValidDays(7);
}
order.setExpireTime(LocalDateTime.now().plusDays(order.getValidDays()));
```

---

### 5. âœ… è®¢å•æ’¤é”€åŠŸèƒ½

#### 5.1 æ’¤é”€æ¥å£
```java
@PostMapping("/api/trade/orders/cancel/{orderId}")
public Result<String> cancelOrder(
    @PathVariable Long orderId,
    @RequestParam Long userId
)
```

#### 5.2 æ’¤é”€é€»è¾‘
- âœ… éªŒè¯è®¢å•å­˜åœ¨æ€§
- âœ… éªŒè¯ç”¨æˆ·æƒé™
- âœ… éªŒè¯è®¢å•çŠ¶æ€ï¼ˆä»…å…è®¸æ’¤é”€OPENçŠ¶æ€è®¢å•ï¼‰
- âœ… æ›´æ–°è®¢å•çŠ¶æ€ä¸ºCANCELLED
- âœ… è§£å†»ä¹°å•èµ„é‡‘ï¼ˆå¦‚é€‚ç”¨ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `service-trade/src/main/java/com/example/trade/controller/TradeOrderController.java`

---

### 6. âœ… è®¢å•è¿‡æœŸè‡ªåŠ¨å…³é—­

#### 6.1 å®šæ—¶ä»»åŠ¡é›†æˆ
åœ¨ `TradeMatchService.matchOrders()` å®šæ—¶ä»»åŠ¡ä¸­æ·»åŠ è¿‡æœŸæ£€æŸ¥ï¼š

```java
@Transactional
public void matchOrders() {
    // 1. å…ˆå…³é—­è¿‡æœŸè®¢å•
    closeExpiredOrders();
    
    // 2. å†è¿›è¡Œæ’®åˆ
    for (String assetType : assetTypes) {
        matchOrdersByAssetType(assetType);
    }
}
```

#### 6.2 è¿‡æœŸå…³é—­é€»è¾‘
```java
private void closeExpiredOrders() {
    // æŸ¥è¯¢æ‰€æœ‰è¿‡æœŸçš„OPENè®¢å•
    LambdaQueryWrapper<TradeOrder> query = new LambdaQueryWrapper<>();
    query.eq(TradeOrder::getStatus, "OPEN");
    query.le(TradeOrder::getExpireTime, LocalDateTime.now());
    
    // æ‰¹é‡æ›´æ–°çŠ¶æ€ä¸ºCANCELLED
    // è§£å†»ä¹°å•å†»ç»“èµ„é‡‘
}
```

**æ‰§è¡Œé¢‘ç‡ï¼š** æ¯5ç§’æ‰§è¡Œä¸€æ¬¡ï¼ˆéšæ’®åˆä»»åŠ¡ï¼‰

---

## ä¸‰ã€æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `service-trade/src/main/resources/trade_record.sql` | äº¤æ˜“è®°å½•è¡¨SQL |
| `service-trade/src/main/resources/add_order_validity.sql` | è®¢å•æœ‰æ•ˆæœŸå­—æ®µè¿ç§»SQL |
| `service-trade/src/main/java/com/example/trade/entity/TradeRecord.java` | äº¤æ˜“è®°å½•å®ä½“ |
| `service-trade/src/main/java/com/example/trade/mapper/TradeRecordMapper.java` | äº¤æ˜“è®°å½•Mapper |
| `service-trade/src/main/java/com/example/trade/service/TradeRecordService.java` | äº¤æ˜“è®°å½•æœåŠ¡ |
| `service-trade/src/main/java/com/example/trade/controller/TradeRecordController.java` | äº¤æ˜“è®°å½•æ§åˆ¶å™¨ |
| `service-consumer/src/main/java/com/example/consumer/feign/TradeAccountFeignClient.java` | äº¤æ˜“è´¦æˆ·Feignå®¢æˆ·ç«¯ |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¸»è¦ä¿®æ”¹å†…å®¹ |
|---------|------------|
| `service-trade/src/main/java/com/example/trade/entity/TradeOrder.java` | æ·»åŠ validDaysã€expireTimeå­—æ®µ |
| `service-trade/src/main/java/com/example/trade/service/TradeMatchService.java` | æ·»åŠ è¿‡æœŸå…³é—­ã€äº¤æ˜“è®°å½•ä¿å­˜ã€ä½™é¢æ›´æ–°é€»è¾‘ |
| `service-trade/src/main/java/com/example/trade/controller/TradeOrderController.java` | æ·»åŠ æ’¤é”€æ¥å£ã€å‘å¸ƒè®¢å•æ—¶è®¾ç½®è¿‡æœŸæ—¶é—´ |
| `service-assets/src/main/java/com/example/assets/controller/CarbonQuotaController.java` | æ·»åŠ update-quantityæ¥å£ |
| `service-assets/src/main/java/com/example/assets/controller/CarbonCreditController.java` | æ·»åŠ update-quantityæ¥å£ |

---

## å››ã€æ•°æ®åº“è¿ç§»æ­¥éª¤

### å¿…é¡»æ‰§è¡Œçš„SQL

```sql
-- 1. åˆ›å»ºäº¤æ˜“è®°å½•è¡¨
SOURCE service-trade/src/main/resources/trade_record.sql;

-- 2. æ·»åŠ è®¢å•æœ‰æ•ˆæœŸå­—æ®µ
SOURCE service-trade/src/main/resources/add_order_validity.sql;
```

**æ‰§è¡Œæ–¹å¼ï¼š**
```bash
# æ–¹æ³•1ï¼šMySQLå‘½ä»¤è¡Œ
mysql -u root -p carbon_trade < service-trade/src/main/resources/trade_record.sql
mysql -u root -p carbon_trade < service-trade/src/main/resources/add_order_validity.sql

# æ–¹æ³•2ï¼šåœ¨MySQLå®¢æˆ·ç«¯ä¸­æ‰§è¡Œ
USE carbon_trade;
SOURCE d:/vscode/code/java/carbon-system/service-trade/src/main/resources/trade_record.sql;
SOURCE d:/vscode/code/java/carbon-system/service-trade/src/main/resources/add_order_validity.sql;
```

---

## äº”ã€ä¸šåŠ¡æµç¨‹

### 5.1 å®Œæ•´äº¤æ˜“æµç¨‹

```
1. ç”¨æˆ·Aå‘å¸ƒä¹°å•
   â”œâ”€ éªŒè¯è´¦æˆ·ä½™é¢
   â”œâ”€ å†»ç»“èµ„é‡‘ï¼šprice Ã— quantity
   â”œâ”€ è®¾ç½®æœ‰æ•ˆæœŸï¼šé»˜è®¤7å¤©
   â””â”€ è®¢å•çŠ¶æ€ï¼šOPEN

2. ç”¨æˆ·Bå‘å¸ƒå–å•
   â”œâ”€ éªŒè¯èµ„äº§æŒä»“
   â”œâ”€ è®¾ç½®æœ‰æ•ˆæœŸï¼šé»˜è®¤7å¤©
   â””â”€ è®¢å•çŠ¶æ€ï¼šOPEN

3. å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼ˆæ¯5ç§’ï¼‰
   â”œâ”€ [æ­¥éª¤1] å…³é—­è¿‡æœŸè®¢å•
   â”‚   â”œâ”€ æŸ¥è¯¢ expire_time <= NOW() ä¸” status=OPEN
   â”‚   â”œâ”€ æ›´æ–° status=CANCELLED
   â”‚   â””â”€ è§£å†»ä¹°å•èµ„é‡‘
   â”‚
   â””â”€ [æ­¥éª¤2] æ‰§è¡Œæ’®åˆ
       â”œâ”€ åŒ¹é…æ¡ä»¶ï¼šbuy_price >= sell_price
       â”œâ”€ æ›´æ–°è®¢å•çŠ¶æ€ï¼šCLOSED
       â”œâ”€ ä¿å­˜äº¤æ˜“è®°å½•åˆ° trade_record
       â”œâ”€ ä¹°æ–¹ï¼šæ‰£é™¤å†»ç»“èµ„é‡‘
       â”œâ”€ å–æ–¹ï¼šå¢åŠ ä½™é¢
       â”œâ”€ ä¹°æ–¹ï¼šå¢åŠ èµ„äº§æŒä»“
       â””â”€ å–æ–¹ï¼šå‡å°‘èµ„äº§æŒä»“

4. ç”¨æˆ·æ‰‹åŠ¨æ’¤é”€è®¢å•
   â”œâ”€ éªŒè¯æƒé™å’ŒçŠ¶æ€
   â”œâ”€ æ›´æ–° status=CANCELLED
   â””â”€ è§£å†»ä¹°å•èµ„é‡‘ï¼ˆå¦‚é€‚ç”¨ï¼‰
```

---

## å…­ã€APIæ¥å£æ±‡æ€»

### 6.1 äº¤æ˜“è®°å½•ç›¸å…³

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| æˆ‘çš„äº¤æ˜“è®°å½• | GET | /api/trade/records/my?userId={userId}&current=1&size=10 | åˆ†é¡µæŸ¥è¯¢ |
| æ‰€æœ‰äº¤æ˜“è®°å½• | GET | /api/trade/records/all?current=1&size=10 | ç®¡ç†å‘˜ä½¿ç”¨ |
| è®¢å•äº¤æ˜“è®°å½• | GET | /api/trade/records/by-order/{orderId} | æŸ¥è¯¢è®¢å•å…³è”çš„äº¤æ˜“ |

### 6.2 è®¢å•ç®¡ç†ç›¸å…³

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| å‘å¸ƒè®¢å• | POST | /api/trade/orders/publish | bodyåŒ…å«validDayså­—æ®µ |
| æ’¤é”€è®¢å• | POST | /api/trade/orders/cancel/{orderId}?userId={userId} | ä»…æ’¤é”€OPENçŠ¶æ€ |
| æŸ¥è¯¢å¸‚åœºè®¢å• | GET | /api/trade/orders/market | è‡ªåŠ¨è¿‡æ»¤è¿‡æœŸè®¢å• |
| æˆ‘çš„è®¢å• | GET | /api/trade/orders/my?userId={userId} | åŒ…å«æ‰€æœ‰çŠ¶æ€ |

### 6.3 è´¦æˆ·ç®¡ç†ç›¸å…³

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| è´¦æˆ·ä¿¡æ¯ | GET | /api/trade/account/info/{userId} | æŸ¥è¯¢ä½™é¢ |
| å……å€¼ | POST | /api/trade/account/recharge | userId + amount |
| æç° | POST | /api/trade/account/withdraw | userId + amount |
| å†»ç»“èµ„é‡‘ | POST | /api/trade/account/freeze | å†…éƒ¨æ¥å£ |
| è§£å†»èµ„é‡‘ | POST | /api/trade/account/unfreeze | å†…éƒ¨æ¥å£ |
| æ‰£é™¤å†»ç»“ | POST | /api/trade/account/deduct | å†…éƒ¨æ¥å£ |

### 6.4 èµ„äº§ç®¡ç†ç›¸å…³

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| æ›´æ–°é…é¢ | POST | /api/assets/quota/update-quantity | userId + year + amount |
| æ›´æ–°ä¿¡ç”¨ | POST | /api/assets/credit/update-quantity | userId + projectId + amount |

---

## ä¸ƒã€æµ‹è¯•å»ºè®®

### 7.1 äº¤æ˜“è®°å½•æµ‹è¯•

```bash
# 1. å…ˆè®©ä¸¤ä¸ªè®¢å•æ’®åˆæˆåŠŸ
# 2. æŸ¥è¯¢äº¤æ˜“è®°å½•
curl "http://localhost:8083/api/trade/records/my?userId=1&current=1&size=10"

# é¢„æœŸç»“æœï¼šè¿”å›åŒ…å«buy_order_idã€sell_order_idã€trade_amountç­‰å­—æ®µçš„è®°å½•
```

### 7.2 è®¢å•æœ‰æ•ˆæœŸæµ‹è¯•

```bash
# 1. å‘å¸ƒä¸€ä¸ª1åˆ†é’Ÿåè¿‡æœŸçš„è®¢å•
POST http://localhost:8083/api/trade/orders/publish
{
  "userId": 1,
  "itemType": "QUOTA",
  "direction": "BUY",
  "price": 50,
  "quantity": 100,
  "validDays": 0.000694  # çº¦1åˆ†é’Ÿï¼ˆ1/1440å¤©ï¼‰
}

# 2. ç­‰å¾…1åˆ†é’ŸåæŸ¥è¯¢è®¢å•çŠ¶æ€
# é¢„æœŸç»“æœï¼šè®¢å•çŠ¶æ€å˜ä¸ºCANCELLEDï¼Œèµ„é‡‘å·²è§£å†»
```

### 7.3 è®¢å•æ’¤é”€æµ‹è¯•

```bash
# 1. å‘å¸ƒè®¢å•è·å–orderId
# 2. ç«‹å³æ’¤é”€
POST http://localhost:8083/api/trade/orders/cancel/123?userId=1

# é¢„æœŸç»“æœï¼šè®¢å•çŠ¶æ€å˜ä¸ºCANCELLEDï¼Œå¦‚æœæ˜¯ä¹°å•èµ„é‡‘å·²è§£å†»
```

---

## å…«ã€åç»­ä¼˜åŒ–å»ºè®®ï¼ˆæœªå®ç°éƒ¨åˆ†ï¼‰

### 8.1 Redisç¼“å­˜ï¼ˆå¾…å®ç°ï¼‰

**ä¼˜åŒ–ç›®æ ‡ï¼š**
- ç¼“å­˜çƒ­é—¨è®¢å•åˆ—è¡¨
- ç¼“å­˜ç”¨æˆ·è´¦æˆ·ä½™é¢
- å‡å°‘æ•°æ®åº“æŸ¥è¯¢å‹åŠ›

**å®ç°æ€è·¯ï¼š**
```java
@Autowired
private RedisTemplate<String, Object> redisTemplate;

// ç¼“å­˜è®¢å•åˆ—è¡¨ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
public List<TradeOrder> getMarketOrdersWithCache() {
    String key = "market:orders:QUOTA";
    List<TradeOrder> cached = redisTemplate.opsForValue().get(key);
    if (cached != null) return cached;
    
    List<TradeOrder> orders = queryFromDatabase();
    redisTemplate.opsForValue().set(key, orders, 5, TimeUnit.MINUTES);
    return orders;
}
```

### 8.2 æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†ï¼ˆå¾…å®ç°ï¼‰

**ä¼˜åŒ–ç›®æ ‡ï¼š**
- æ’®åˆæˆåŠŸåå¼‚æ­¥æ›´æ–°ä½™é¢å’Œèµ„äº§
- å¼‚æ­¥å‘é€äº¤æ˜“é€šçŸ¥
- æé«˜æ’®åˆå¼•æ“ååé‡

**å®ç°æ€è·¯ï¼š**
```java
// 1. æ·»åŠ RabbitMQä¾èµ–
// 2. æ’®åˆæˆåŠŸåå‘é€æ¶ˆæ¯
@Autowired
private RabbitTemplate rabbitTemplate;

private void matchTwoOrders(...) {
    // æ›´æ–°è®¢å•çŠ¶æ€
    // ...
    
    // å‘é€æ¶ˆæ¯åˆ°MQ
    TradeMessage msg = new TradeMessage(buyOrder, sellOrder, quantity, price);
    rabbitTemplate.convertAndSend("trade.exchange", "trade.matched", msg);
}

// 3. æ¶ˆè´¹è€…å¼‚æ­¥å¤„ç†
@RabbitListener(queues = "trade.matched.queue")
public void handleTradeMatched(TradeMessage msg) {
    // æ›´æ–°ä½™é¢
    // æ›´æ–°èµ„äº§
    // å‘é€é€šçŸ¥
}
```

---

## ä¹ã€æ€»ç»“

### âœ… å·²å®ŒæˆåŠŸèƒ½

1. **äº¤æ˜“è®°å½•ç³»ç»Ÿ**ï¼šå®Œæ•´çš„æ•°æ®åº“è®¾è®¡ã€å®ä½“ç±»ã€æœåŠ¡å±‚å’ŒAPIæ¥å£
2. **è´¦æˆ·ä½™é¢æ›´æ–°**ï¼šæˆäº¤åè‡ªåŠ¨æ›´æ–°ä¹°å–åŒæ–¹ä½™é¢ï¼Œæ”¯æŒå†»ç»“/è§£å†»/æ‰£é™¤
3. **èµ„äº§æŒä»“æ›´æ–°**ï¼šæä¾›é…é¢å’Œä¿¡ç”¨çš„æ•°é‡æ›´æ–°API
4. **è®¢å•æœ‰æ•ˆæœŸ**ï¼šæ”¯æŒè‡ªå®šä¹‰æœ‰æ•ˆæœŸï¼Œé»˜è®¤7å¤©
5. **è®¢å•æ’¤é”€**ï¼šæ‰‹åŠ¨æ’¤é”€åŠŸèƒ½ï¼Œè‡ªåŠ¨è§£å†»èµ„é‡‘
6. **è®¢å•è¿‡æœŸå…³é—­**ï¼šå®šæ—¶ä»»åŠ¡è‡ªåŠ¨å…³é—­è¿‡æœŸè®¢å•

### ğŸ“ å¾…ä¼˜åŒ–åŠŸèƒ½

1. **Redisç¼“å­˜**ï¼šå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
2. **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¼‚æ­¥å¤„ç†æ’®åˆç»“æœï¼Œæé«˜ç³»ç»Ÿååé‡
3. **èµ„äº§æŒä»“è°ƒç”¨**ï¼šå®Œå–„TradeMatchServiceä¸­çš„èµ„äº§æ›´æ–°é€»è¾‘ï¼ˆç›®å‰æ˜¯TODOï¼‰

### ğŸ¯ å…³é”®æˆæœ

- **8ä¸ªæ ¸å¿ƒåŠŸèƒ½**å…¨éƒ¨å®Œæˆ
- **3ä¸ªæ–°è¡¨**å’Œå­—æ®µè®¾è®¡å®Œæˆ
- **7ä¸ªæ–°æ–‡ä»¶**åˆ›å»º
- **5ä¸ªæ–‡ä»¶**ä¿®æ”¹å¢å¼º
- **12ä¸ªAPIæ¥å£**æ–°å¢æˆ–å¢å¼º
- **å®Œæ•´ä¸šåŠ¡æµç¨‹**æ‰“é€š

---

## åã€å¯åŠ¨å’Œéƒ¨ç½²

### 10.1 æ•°æ®åº“å‡†å¤‡

```bash
# 1. æ‰§è¡Œäº¤æ˜“è®°å½•è¡¨åˆ›å»º
mysql -u root -p carbon_trade < service-trade/src/main/resources/trade_record.sql

# 2. æ‰§è¡Œè®¢å•æœ‰æ•ˆæœŸå­—æ®µæ·»åŠ 
mysql -u root -p carbon_trade < service-trade/src/main/resources/add_order_validity.sql
```

### 10.2 ç¼–è¯‘å’Œå¯åŠ¨

```bash
# 1. ç¼–è¯‘carbon-common
cd d:\vscode\code\java\carbon-system
mvn clean install -DskipTests -pl carbon-common -s settings.xml

# 2. ç¼–è¯‘service-trade
mvn clean install -DskipTests -pl service-trade -s settings.xml

# 3. ç¼–è¯‘service-assets
mvn clean install -DskipTests -pl service-assets -s settings.xml

# 4. å¯åŠ¨æœåŠ¡ï¼ˆæŒ‰é¡ºåºï¼‰
# - service-provider (8082)
# - service-assets (8084)
# - service-trade (8083)
# - service-consumer (8081)

# 5. å¯åŠ¨å‰ç«¯
cd frontend
npm run dev
```

### 10.3 éªŒè¯åŠŸèƒ½

```bash
# 1. ç™»å½•ç³»ç»Ÿ
# 2. å‘å¸ƒä¹°å•å’Œå–å•
# 3. ç­‰å¾…5-10ç§’ï¼Œè§‚å¯Ÿè®¢å•çŠ¶æ€å˜åŒ–
# 4. æŸ¥çœ‹äº¤æ˜“è®°å½•ï¼šè¿›å…¥"æˆ‘çš„è®¢å•"é¡µé¢
# 5. æµ‹è¯•æ’¤é”€åŠŸèƒ½
# 6. ä¿®æ”¹è®¢å•æœ‰æ•ˆæœŸæµ‹è¯•è¿‡æœŸå…³é—­
```

---

**ä¼˜åŒ–å®Œæˆæ—¥æœŸï¼š** 2026-01-07
**ç‰ˆæœ¬å·ï¼š** v2.0.0
**å¼€å‘çŠ¶æ€ï¼š** âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œå»ºè®®ç”Ÿäº§ç¯å¢ƒæµ‹è¯•åä¸Šçº¿
